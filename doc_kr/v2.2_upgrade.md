# V2.2 업그레이드

### 전제 조건

1. 배포자 키("배포자 키")
2. 프록시 관리자 키("관리자 키")
3. `blacklist.remote.json`에 저장된 현재 블랙리스트에 오른 계정 목록

### 준비

1. 블록 탐색기를 사용하거나 아래 명령을 사용하여 대상 FiatTokenProxy 계약의 계약
   생성 블록 번호를 가져옵니다.

   ```sh
   $ yarn hardhat getContractCreationBlock --network ${NETWORK} ${FiatTokenProxy 주소}
   ```

2. 다음 명령을 실행하여 대상 FiatTokenProxy 계약에서 현재 블랙리스트에 오른 계정
   목록을 가져옵니다. `startBlockNumber`는 대상 FiatTokenProxy 계약의 계약 생성
   블록 번호로 설정해야 합니다.

   ```sh
   $ yarn hardhat downloadBlacklistedAccounts --network ${NETWORK} \
         --proxy-address ${FiatTokenProxy 주소} \
         --start-block-number ${startBlockNumber}
   ```

### 단계

1. 프로젝트 루트 폴더에서 `.env.example`의 복사본을 만들고 파일 이름을 `.env`로
   지정합니다. `.env`가 올바른 값으로 구성되었는지 확인합니다. 환경 변수
   `PROXY_ADMIN_ADDRESS`, `FIAT_TOKEN_PROXY_ADDRESS`가 정의되어 있어야 합니다.

2. 터미널에서 배포할 네트워크로 `NETWORK` 변수를 설정합니다.

   ```sh
   $ NETWORK=<mainnet|testnet>;
   ```

3. [`./scripts/deploy/`](../scripts/deploy/)에서
   `deploy-impl-and-upgrader.s.sol` 스크립트를 찾습니다. 로컬 `.env` 파일에 다음
   변수가 올바르게 구성되었는지 확인합니다.

   ```sh
   $ DEPLOYER_PRIVATE_KEY=<DEPLOYER_PRIVATE_KEY>
   $ FIAT_TOKEN_PROXY_ADDRESS=<FIAT_TOKEN_PROXY_ADDRESS>
   $ PROXY_ADMIN_ADDRESS=<PROXY_ADMIN_ADDRESS>
   $ LOST_AND_FOUND_ADDRESS=<LOST_AND_FOUND_ADDRESS>
   $ TOKEN_SYMBOL=<TOKEN_SYMBOL>

   # [선택 사항] 구현 계약이 이미 있는 경우 입력
   $ FIAT_TOKEN_IMPLEMENTATION_ADDRESS=<FIAT_TOKEN_IMPLEMENTATION_ADDRESS>
   ```

4. 프로젝트 루트 폴더의 `blacklist.remote.json` 파일이 올바른 블랙리스트 주소 목
   록으로 구성되었는지 확인합니다.

5. 다음 명령을 실행하여 파운드리 배포 시뮬레이션을 실행합니다.

   ```sh
   yarn forge:simulate scripts/deploy/deploy-impl-and-upgrader.s.sol --rpc-url $NETWORK
   ```

   모든 필드가 올바르게 채워졌는지 확인합니다.

   **_참고:_** 추가 정보는 로컬 시스템에서 자동으로 생성되는
   `./broadcast/deploy-impl-and-upgrader.s.sol/:chainId/dry-run` 폴더를 확인하여
   브로드캐스트할 각 트랜잭션을 확인할 수도 있습니다.

6. 다음 명령을 실행하여 계약을 배포합니다.

   ```sh
   yarn forge:broadcast scripts/deploy/deploy-impl-and-upgrader.s.sol --rpc-url $NETWORK
   ```

7. 다음 명령을 실행하여 Etherscan 플레이버 블록 탐색기에서 계약을 확인합니다.
   `.env` 파일에 `ETHERSCAN_KEY`가 설정되었는지 확인합니다.

   ```sh
   yarn forge:verify scripts/deploy/deploy-impl-and-upgrader.s.sol --rpc-url $NETWORK
   ```

8. 업그레이더 계약이 올바르게 배포되었는지 확인합니다. 블록 탐색기를 사용하거나
   아래 명령을 사용하여 `V2_2Upgrader` 계약의 `proxy()`, `implementation()` 및
   `newProxyAdmin()`에서 반환된 값이 올바른지 확인합니다.

   ```sh
   $ yarn compile
   $ yarn hardhat readValuesFromContract --network ${NETWORK} \
         --contract-name V2_2Upgrader \
         --contract-address ${V2_2Upgrader 주소} \
         proxy implementation newProxyAdmin
   ```

9. `V2_2UpgraderHelper` 계약이 올바르게 배포되었는지 확인합니다. `V2_2Upgrader`
   계약 `helper()` 메서드에서 주소를 검색하고 블록 탐색기를 사용하거나 아래 명령
   을 사용하여 각 뷰 메서드의 반환 값이 업그레이드할 `FiatTokenProxy` 계약과 일
   치하는지 확인합니다.

   ```sh
   $ yarn compile
   $ yarn hardhat readValuesFromContract --network ${NETWORK} \
         --contract-name V2_2Upgrader \
         --contract-address ${V2_2Upgrader 주소} \
         helper
   $ yarn hardhat readValuesFromContract --network ${NETWORK} \
         --contract-name V2_2UpgraderHelper \
         --contract-address ${V2_2UpgraderHelper 주소} \
         name symbol decimals currency masterMinter fiatTokenOwner pauser blacklister version DOMAIN_SEPARATOR rescuer paused totalSupply

   # 위 결과를 다음과 비교
   $ yarn hardhat readValuesFromContract --network ${NETWORK} \
         --contract-name FiatTokenV2_1 \
         --contract-address ${FiatTokenProxy 주소} \
         name symbol decimals currency masterMinter fiatTokenOwner pauser blacklister version DOMAIN_SEPARATOR rescuer paused totalSupply
   ```

10. 블랙리스트에 추가할 계정 목록이 올바른지, 업그레이더 계약에 올바르게 설정되
    었는지 확인합니다. 다음 명령을 실행하여 목록을 확인합니다.

    ```sh
    $ yarn hardhat validateAccountsToBlacklist --network=${NETWORK} \
          --proxy-address ${FiatTokenProxy 주소} \
          --upgrader-address ${V2_2Upgrader 주소}
    ```

11. 관리자 키를 사용하여 `FiatTokenProxy` 계약에서 `changeAdmin(address)` 메서드
    를 호출하여 프록시 관리자 역할을 `V2_2Upgrader` 계약 주소로 이전합니다.

12. 0.20 FiatToken(예: USDC)을 `V2_2Upgrader` 계약 주소로 보냅니다. (200,000 토
    큰)

13. 배포자 키를 사용하여 `V2_2Upgrader`에서 `upgrade()` (`0xd55ec697`) 메서드를
    호출합니다.

#### 업그레이드 트랜잭션이 성공하면

- 프록시 관리자 역할이 관리자 키로 다시 이전되었는지 확인합니다.
- 추가 조치가 필요하지 않습니다.

#### 업그레이드 트랜잭션이 실패하면

- 트랜잭션이 실패하면 `upgrade` 함수 호출 중에 발생한 모든 상태 변경이 되돌려집
  니다.
- `V2_2Upgrader` 계약에서 `abortUpgrade()` (`0xd8f6a8f6`) 메서드를 호출하여 해체
  합니다.
